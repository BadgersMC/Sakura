From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Samsuik <40902469+Samsuik@users.noreply.github.com>
Date: Sun, 26 Nov 2023 17:57:50 +0000
Subject: [PATCH] Treat all collidable blocks as full while moving fast


diff --git a/src/main/java/io/papermc/paper/util/CollisionUtil.java b/src/main/java/io/papermc/paper/util/CollisionUtil.java
index 39085c2a356f575f0ef6acaa3de7d9ff560b5a87..7828f8a755343aca24ef81fa5738d19b74a7299b 100644
--- a/src/main/java/io/papermc/paper/util/CollisionUtil.java
+++ b/src/main/java/io/papermc/paper/util/CollisionUtil.java
@@ -1581,6 +1581,7 @@ public final class CollisionUtil {
     public static final int COLLISION_FLAG_CHECK_BORDER = 1 << 2;
     public static final int COLLISION_FLAG_CHECK_ONLY = 1 << 3;
     public static final int COLLISION_FLAG_ADD_TICKET = 1 << 4; // Sakura
+    public static final int COLLISION_FLAG_FULL_BLOCKS = 1 << 5; // Sakura
 
     public static boolean getCollisionsForBlocksOrWorldBorder(final Level world, final Entity entity, final AABB aabb,
                                                               final List<VoxelShape> intoVoxel, final List<AABB> intoAABB,
@@ -1632,6 +1633,7 @@ public final class CollisionUtil {
 
         final boolean loadChunks = (collisionFlags & COLLISION_FLAG_LOAD_CHUNKS) != 0;
         final boolean addTicket  = (collisionFlags & COLLISION_FLAG_ADD_TICKET) != 0; // Sakura
+        final boolean fullBlocks = (collisionFlags & COLLISION_FLAG_FULL_BLOCKS) != 0; // Sakura
         final ServerChunkCache chunkSource = (ServerChunkCache)world.getChunkSource();
 
         for (int currChunkZ = minChunkZ; currChunkZ <= maxChunkZ; ++currChunkZ) {
@@ -1672,7 +1674,7 @@ public final class CollisionUtil {
                         continue;
                     }
 
-                    final boolean hasSpecial = section.getSpecialCollidingBlocks() != 0;
+                    final boolean hasSpecial = !fullBlocks && section.getSpecialCollidingBlocks() != 0; // Sakura
                     final int sectionAdjust = !hasSpecial ? 1 : 0;
 
                     final PalettedContainer<BlockState> blocks = section.states;
@@ -1706,12 +1708,20 @@ public final class CollisionUtil {
                                 }
 
                                 if (edgeCount == 0 || ((edgeCount != 1 || blockData.hasLargeCollisionShape()) && (edgeCount != 2 || blockData.getBlock() == Blocks.MOVING_PISTON))) {
-                                    VoxelShape blockCollision = blockData.getConstantCollisionShape();
+                                    // Sakura start - if flag is set treat all block as full
+                                    VoxelShape blockCollision;
 
-                                    if (blockCollision == null) {
-                                        mutablePos.set(blockX, blockY, blockZ);
-                                        blockCollision = blockData.getCollisionShape(world, mutablePos, collisionShape);
+                                    if (fullBlocks) {
+                                        blockCollision = Shapes.block();
+                                    } else {
+                                        blockCollision = blockData.getConstantCollisionShape();
+
+                                        if (blockCollision == null) {
+                                            mutablePos.set(blockX, blockY, blockZ);
+                                            blockCollision = blockData.getCollisionShape(world, mutablePos, collisionShape);
+                                        }
                                     }
+                                    // Sakura end
 
                                     AABB singleAABB = blockCollision.getSingleAABBRepresentation();
                                     if (singleAABB != null) {
diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index 852276d9bedc51c3c8a28b60c85fdb23cf9cf818..2588180e543dc8ca2e41c15802b59c9b87df7ee6 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -547,6 +547,14 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource, S
             flags |= io.papermc.paper.util.CollisionUtil.COLLISION_FLAG_LOAD_CHUNKS | io.papermc.paper.util.CollisionUtil.COLLISION_FLAG_ADD_TICKET;
         }
 
+        if (this.level().sakuraConfig().cannons.treatAllBlocksAsFullWhenMoving && this.isPrimedTNT | this.isFallingBlock) {
+            this.syncDeltaMovement();
+            double horizontalMovementSqr = this.movementX*this.movementX + this.movementZ*this.movementZ;
+            if (horizontalMovementSqr > Math.pow(this.level().sakuraConfig().cannons.treatAllBlocksAsFullWhenMovingFasterThan, 2.0)) {
+                flags |= io.papermc.paper.util.CollisionUtil.COLLISION_FLAG_FULL_BLOCKS;
+            }
+        }
+
         return flags;
     }
     // Sakura end
